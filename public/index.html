<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Controle Fácil - Devoluções</title>
  
  <meta name="ml-seller-id" content="">
  <meta name="ml-seller-nick" content="">

  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="css/navigation.css">
  <link rel="stylesheet" href="css/index.css">
  <link rel="icon" href="assets/img/favicon.png" type="image/png"/>
</head>

<body class="index-page" data-page="devolucoes">
  <aside id="sidebar" class="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-logo">
        <span class="sidebar-logo-text">Controle Fácil</span>
      </div>
      <button id="sidebar-toggle" class="sidebar-toggle" aria-label="Alternar sidebar">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>
      </button>
    </div>

    <nav class="sidebar-nav">
      <a href="home.html" class="sidebar-nav-item" data-page="home">
        <svg class="sidebar-nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
        <span class="sidebar-nav-text">Home</span>
      </a>
      <a href="central.html" class="sidebar-nav-item" data-page="central">
        <svg class="sidebar-nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
        <span class="sidebar-nav-text">Central</span>
      </a>
      <a href="index.html" class="sidebar-nav-item is-active" data-page="devolucoes" aria-current="page">
        <svg class="sidebar-nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 14 4 9 9 4"/><path d="M20 20v-7a4 4 0 0 0-4-4H4"/></svg>
        <span class="sidebar-nav-text">Devoluções</span>
      </a>
      <a href="dashboard.html" class="sidebar-nav-item" data-page="dashboards">
        <svg class="sidebar-nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="8"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6"  y1="20" x2="6"  y2="14"/></svg>
        <span class="sidebar-nav-text">Dashboards</span>
      </a>
      <a href="logs.html" class="sidebar-nav-item" data-page="logs">
        <svg class="sidebar-nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
        <span class="sidebar-nav-text">Logs</span>
      </a>
      <a href="chat.html" class="sidebar-nav-item" data-page="chat">
        <svg class="sidebar-nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a4 4 0 0 1-4 4H8l-5 3V7a4 4 0 0 1 4-4h10a4 4 0 0 1 4 4z"/></svg>
        <span class="sidebar-nav-text">Chat</span>
      </a>
      <a href="settings/config.html" class="sidebar-nav-item" data-page="settings">
        <svg class="sidebar-nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7Z"/><path d="M19.4 15a1 1 0 0 0 .2 1.1l.1.1a1 1 0 0 1-.2 1.6l-1.6.9a1 1 0 0 1-1.2-.1l-.1-.1a7.9 7.9 0 0 1-1 .6 1 1 0 0 0-.6.9l-.1 1.8a1 1 0 0 1-1 .9h-1.8a1 1 0 0 1-1-.9l-.1-1.8a1 1 0 0 0-.6-.9 7.9 7.9 0 0 1-1-.6 1 1 0 0 1-1.3.2l-1.6-.9a1 1 0 0 1-.3-1.6l.1-.1A1 1 0 0 0 4.6 15l-1.6-.9a1 1 0 0 1-.5-1.3l.7-1.7a1 1 0 0 1 1-.6h.2c.3-.2.6-.4.9-.6a1 1 0 0 0 .4-1l-.2-1.8A1 1 0 0 1 6.5 4H8.3a1 1 0 0 1 1 .9l.1 1.8a1 1 0 0 0 .6.9l1 .6 1-.6a1 1 0 0 0 .6-.9l.1-1.8a1 1 0 0 1 1-.9h1.8a1 1 0 0 1 1 .9l-.2 1.8a1 1 0 0 0 .4 1c.3.2.6.4.9.6h.2a1 1 0 0 1 1 .6l.7 1.7a1 1 0 0 1-.5 1.3Z"/></svg>
        <span class="sidebar-nav-text">Configurações</span>
      </a>
    </nav>
    <div class="sidebar-footer"></div>
  </aside>

  <div id="sidebar-overlay" class="sidebar-overlay" aria-hidden="true"></div>
  <button id="sidebar-toggle-mobile" class="sidebar-fab" aria-label="Abrir menu">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12h18M3 6h18M3 18h18"/></svg>
  </button>

  <header id="cabecalho" class="cabecalho">
    <div class="container">
      <div class="cabecalho-conteudo">
        <div class="logo-area">
          <div class="titulo-area">
            <h1 class="titulo-principal">Controle Fácil</h1>
            <p class="subtitulo">Gestão de Devoluções</p>
          </div>
        </div>

        <div class="acoes-header">
          <button id="botao-sync" class="botao botao-outline" type="button">
            <svg class="icone" viewBox="0 0 16 16" fill="currentColor" aria-hidden="true">
              <path d="M8 3a5 5 0 1 1-4.546 2.916.5.5 0 1 1 .912-.41A4 4 0 1 0 8 4V1.5a.5.5 0 0 1 1 0V4A.5.5 0 0 1 8.5 4.5H6a.5.5 0 0 1 0-1h1.5V3z"/>
            </svg>
            Sincronizar
          </button>
          <button id="botao-exportar" class="botao botao-outline" type="button">
            <svg class="icone" viewBox="0 0 16 16" fill="currentColor">
              <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
              <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 1-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708z"/>
            </svg>
            Exportar
          </button>
          <button id="btn-nova-devolucao" class="botao botao-principal" type="button">
            <svg class="icone" viewBox="0 0 16 16" fill="currentColor">
              <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
            </svg>
            Nova Devolução
          </button>
        </div>
      </div>
    </div>
  </header>

  <main id="conteudo-principal" class="conteudo-principal">
    <div class="container">
      
      <section id="filtros" class="secao-filtros">
        <div class="filtros-topo">
          <div class="campo-busca-grande">
            <svg class="icone-busca" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
            <input id="campo-pesquisa" class="input-pesquisa-grande" placeholder="Buscar por cliente, pedido, SKU ou status..." aria-label="Pesquisar" />
          </div>
        </div>

        <div class="abas-container">
          <div class="abas-lista" id="lista-abas-status">
            <button class="aba is-active" data-status="todos">
              Todos <span class="aba-count" id="count-todos"></span>
            </button>
            <button class="aba" data-status="pendente">
              A Receber <span class="aba-count" id="count-pendente"></span>
            </button>
            <button class="aba" data-status="em_analise">
              Em Conferência <span class="aba-count" id="count-analise"></span>
            </button>
            <button class="aba" data-status="disputa">
              Em Disputa <span class="aba-count" id="count-disputa"></span>
            </button>
            <button class="aba" data-status="finalizado">
              Concluídos <span class="aba-count" id="count-finalizado"></span>
            </button>
          </div>
        </div>
      </section>

      <section id="lista-devolucoes" class="secao-lista" aria-busy="false">
        <div id="container-devolucoes" class="container-devolucoes" role="list"></div>

        <div id="mensagem-vazia" class="mensagem-vazia" hidden>
          <div class="card-vazio">
            <svg class="icone-vazio" viewBox="0 0 120 120" fill="none"><circle cx="60" cy="60" r="50" fill="#F1F5F9"/><path d="M60 40v20" stroke="#94A3B8" stroke-width="4" stroke-linecap="round"/><circle cx="60" cy="75" r="3" fill="#94A3B8"/></svg>
            <h3 class="titulo-vazio">Nenhum resultado</h3>
            <p id="descricao-vazia" class="descricao-vazio">Não encontramos devoluções com os filtros atuais.</p>
          </div>
        </div>

        <nav id="paginacao" class="paginacao" aria-label="Paginação"></nav>
      </section>

      <section id="loading-skeleton" class="secao-lista" hidden>
        <div class="skeleton-container">
          <div class="skeleton-card">
            <div class="skeleton-media"></div>
            <div class="skeleton-content">
              <div class="skeleton-line title"></div>
              <div class="skeleton-line"></div>
              <div class="skeleton-line short"></div>
            </div>
          </div>
          <div class="skeleton-card">
            <div class="skeleton-media"></div>
            <div class="skeleton-content">
              <div class="skeleton-line title"></div>
              <div class="skeleton-line"></div>
              <div class="skeleton-line short"></div>
            </div>
          </div>
        </div>
      </section>

    </div>
  </main>

  <dialog id="dlg-cd" class="modal-detalhe">
    <form method="dialog" class="modal-card" id="cd-form">
      <header class="modal-header">
        <h3 id="cd-title">Recebido no CD</h3>
        <button type="button" class="modal-close" id="cd-x">✕</button>
      </header>
      <section class="modal-body">
        <input type="hidden" id="cd-id">
        <div class="grid-2">
          <div class="campo-filtro">
            <label for="cd-name" class="campo-label">Responsável</label>
            <input id="cd-name" class="input-form" placeholder="Ex.: João"/>
          </div>
          <div class="campo-filtro">
            <label for="cd-when" class="campo-label">Data/Hora</label>
            <input id="cd-when" type="datetime-local" class="input-form"/>
          </div>
        </div>
        <div class="campo-check-box">
          <input id="cd-ok" type="checkbox" class="checkbox-lg"/>
          <label for="cd-ok">
            <strong>Item chegou íntegro/completo?</strong><br>
            <small>Se marcado, a devolução será finalizada como "Concluída". Caso contrário, será marcada como "Disputa".</small>
          </label>
        </div>
      </section>
      <footer class="modal-footer">
        <button type="button" id="cd-cancel" class="botao botao-outline">Cancelar</button>
        <button type="submit" id="cd-save" class="botao botao-principal">Confirmar Recebimento</button>
      </footer>
    </form>
  </dialog>

  <div id="toast" class="toast" role="status" aria-live="polite">
    <div class="toast-icone"></div>
    <div class="toast-content">
      <strong id="toast-titulo"></strong>
      <div id="toast-descricao"></div>
    </div>
  </div>

  <noscript>
    <style>.conteudo-principal{display:none} .mensagem-vazia{display:block!important}</style>
    <div style="text-align:center;padding:2rem;">Javascript necessário.</div>
  </noscript>

  <script src="js/navigation.js" defer></script>
  <script src="js/index.js" defer></script>

  <script>
    (function(){
      const $ = (id)=>document.getElementById(id);
      function showToast(titulo, desc, tipo){
        const t=$('toast'); $('toast-titulo').textContent=titulo; $('toast-descricao').textContent=desc;
        t.className = `toast show ${tipo||'info'}`;
        setTimeout(()=>t.classList.remove('show'), 3500);
      }
      function closeDlg(){ $('dlg-cd').close ? $('dlg-cd').close() : $('dlg-cd').setAttribute('hidden',''); }
      
      // Abre modal
      window.openReceiveDialog = function(id){
        if(!id) return;
        $('cd-id').value = String(id).replace(/\D+/g,'');
        $('cd-name').value = '';
        const now = new Date(Date.now() - new Date().getTimezoneOffset()*60000);
        $('cd-when').value = now.toISOString().slice(0,16);
        $('cd-ok').checked = false;
        $('dlg-cd').showModal ? $('dlg-cd').showModal() : $('dlg-cd').removeAttribute('hidden');
        setTimeout(()=>$('cd-name').focus(),100);
      };

      // Eventos
      document.addEventListener('click', e=>{
        const btn = e.target.closest('[data-open-receive]');
        if(btn){ e.preventDefault(); window.openReceiveDialog(btn.dataset.id); }
      });
      $('cd-x').onclick = closeDlg;
      $('cd-cancel').onclick = closeDlg;

      // Submit do Recebimento
      $('cd-form').onsubmit = async (e)=>{
        e.preventDefault();
        const id=$('cd-id').value, nome=$('cd-name').value.trim()||'cd', when=$('cd-when').value, ok=$('cd-ok').checked;
        const whenISO = when ? new Date(when).toISOString() : new Date().toISOString();
        
        try {
          // 1. Registrar evento
          const r1 = await fetch(`/api/returns/${id}/cd/receive`, {
            method:'PATCH', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ responsavel:nome, when:whenISO, updated_by:'frontend-idx' })
          });
          if(!r1.ok) throw new Error('Erro ao salvar recebimento');

          // 2. Atualizar status
          const patch = ok 
            ? { status:'concluida', log_status:'aprovado_cd', updated_by:'idx-finalize' }
            : { status:'disputa', log_status:'reprovado_cd', updated_by:'idx-dispute' };
          
          await fetch(`/api/returns/${id}`, {
            method:'PATCH', headers:{'Content-Type':'application/json'},
            body: JSON.stringify(patch)
          });

          closeDlg();
          showToast('Sucesso', ok ? 'Devolução concluída.' : 'Marcada para disputa.', ok?'success':'warning');
          
          // Recarrega lista
          document.dispatchEvent(new CustomEvent('rf:returns:reload'));
        } catch(err){
          showToast('Erro', err.message, 'error');
        }
      };
    })();
  </script>
</body>
</html>
