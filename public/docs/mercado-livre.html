<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Guia · Integração Mercado Livre</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
        :root { --fg:#0f172a; 
            --muted:#64748b; 
            --border:#e2e8f0; 
            --bg:#f8fafc; 
            --primary:#2563eb; 
        }

        * {
            box-sizing:border-box
        }

        body {
            margin:0;
            font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;
            background:var(--bg);
            color:var(--fg)
        }

        header {
            background:#fff;
            border-bottom:1px solid var(--border)
        }

        .wrap {
            max-width:1000px;
            margin:0 auto;
            padding:24px
        }
        
        h1 {
            margin:0;
            font-size:1.5rem
        }
        
        main {
            display:grid;
            grid-template-columns:260px 1fr;
            gap:24px;
            margin-top:18px
        }
        
        nav a {
            display:block;
            padding:8px 10px;
            border-radius:8px;
            color:var(--fg);
            text-decoration:none
        }
        
        nav a:hover {
            background:#eef2ff
        }
        
        section {
            background:#fff;
            border:1px solid var(--border);
            border-radius:12px;
            padding:20px
        }
        
        h2 {
            margin-top:0
        }
        
        code {
            background:#0f172a0d;
            border:1px solid var(--border);
            border-radius:6px;
            padding:0 6px
        }
        
        pre {
            background:#0f172a0d;
            border:1px solid var(--border);
            border-radius:8px;
            padding:12px;
            overflow:auto
        }
        
        .pill {
            display:inline-block;
            padding:.25rem .5rem;
            border:1px solid var(--border);
            border-radius:999px;
            background:#fff
        }
        
        .callout {
            border-left:4px solid var(--primary);
            padding:10px 12px;
            background:#eef2ff;
            border-radius:8px
        }
        
        .kbd {
            border:1px solid var(--border);
            border-bottom-width:3px;
            border-radius:6px;
            padding:0 6px;
            background:#fff
        }
        
        ul {
            margin:0 0 0 18px
        }

  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>Guia de Integração — <span class="pill">Mercado Livre (OAuth 2)</span></h1>
    </div>
  </header>

  <div class="wrap">
    <main>
      <nav aria-label="Sumário">
        <a href="#visao-geral">Visão geral</a>
        <a href="#pre-req">Pré-requisitos</a>
        <a href="#variaveis">Variáveis de ambiente</a>
        <a href="#como-conectar">Como conectar</a>
        <a href="#webhook">Webhook (opcional)</a>
        <a href="#endpoints-app">Endpoints do app</a>
        <a href="#erros-comuns">Erros comuns</a>
        <a href="#faq">FAQ</a>
      </nav>

      <div>
        <section id="visao-geral">
          <h2>Visão geral</h2>
          <p>Esta integração usa o fluxo OAuth 2 do Mercado Livre para obter <em>access_token</em> e <em>refresh_token</em>. Depois de conectado, você pode chamar a API do ML usando o token gerenciado automaticamente pelo servidor.</p>
        </section>

        <section id="pre-req">
          <h2>Pré-requisitos</h2>
          <ul>
            <li>Aplicativo criado no <strong>Mercado Livre Developers</strong> com <em>Client ID</em> e <em>Client Secret</em>.</li>
            <li><strong>Redirect URI</strong> configurado no ML apontando para <code>/auth/ml/callback</code> do seu domínio.</li>
          </ul>
          <div class="callout" style="margin-top:10px">
            Exemplo de redirect: <code>https://SEU-DOMINIO/auth/ml/callback</code>
          </div>
        </section>

        <section id="variaveis">
          <h2>Variáveis de ambiente</h2>
          <ul>
            <li><code>ML_CLIENT_ID</code> – Client ID do app no ML</li>
            <li><code>ML_CLIENT_SECRET</code> – Client Secret</li>
            <li><code>ML_REDIRECT_URI</code> – URL completa do callback (igual à registrada no ML)</li>
            <li><code>ML_AUTH_URL</code> (opcional) – <code>https://auth.mercadolivre.com.br/authorization</code></li>
            <li><code>ML_TOKEN_URL</code> (opcional) – <code>https://api.mercadolibre.com/oauth/token</code></li>
            <li><code>ML_BASE_URL</code>  (opcional) – <code>https://api.mercadolibre.com</code></li>
          </ul>
        </section>

        <section id="como-conectar">
          <h2>Como conectar</h2>
          <ol>
            <li>No menu <strong>Configurações → Integrações</strong>, clique em <span class="kbd">Conectar</span> no card do Mercado Livre.</li>
            <li>Faça login/autorize no Mercado Livre.</li>
            <li>Ao retornar, você verá a tela de sucesso e a conta ficará marcada como ativa.</li>
          </ol>

          <h3>URLs úteis</h3>
          <ul>
            <li>Iniciar login: <code>/auth/ml/login</code></li>
            <li>Callback: <code>/auth/ml/callback</code></li>
          </ul>
        </section>

        <section id="webhook">
          <h2>Webhook (opcional)</h2>
          <p>Se desejar receber eventos do ML, aponte o Webhook do seu app no ML para:</p>
          <pre>/webhooks/ml</pre>
          <p>O endpoint já está disponível no servidor e pode ser adaptado para sua regra de negócio.</p>
        </section>

        <section id="endpoints-app">
          <h2>Endpoints do app</h2>
          <ul>
            <li><code>GET /api/ml/status</code> – status da conexão (e tenta refresh quando necessário)</li>
            <li><code>GET /api/ml/me</code> – dados do usuário autenticado</li>
            <li><code>POST /api/ml/disconnect</code> – limpa a conta (ou remove a ativa no multi-contas)</li>
            <li><code>GET /api/ml/accounts</code> – lista contas salvas (modo multi-contas)</li>
            <li><code>POST /api/ml/active</code> – define a conta ativa (body: <code>{"user_id":"..."}</code>)</li>
          </ul>

          <h3>Exemplos</h3>
            <pre>
                curl -s https://SEU-DOMINIO/api/ml/status
                curl -s https://SEU-DOMINIO/api/ml/me
                curl -s -X POST https://SEU-DOMINIO/api/ml/disconnect
                curl -s https://SEU-DOMINIO/api/ml/accounts
                curl -s -X POST https://SEU-DOMINIO/api/ml/active \
                -H "Content-Type: application/json" \
                -d '{"user_id":"1182709105"}'
            </pre>
        </section>

        <section id="erros-comuns">
          <h2>Erros comuns</h2>
          <ul>
            <li><strong>state inválido</strong>: o cookie de <em>state</em> expirou ou a URL foi reutilizada. Inicie a conexão novamente pelo botão <em>Conectar</em>.</li>
            <li><strong>ML_CLIENT_ID/SECRET ausentes</strong>: confira as variáveis de ambiente.</li>
            <li><strong>redirect_uri mismatch</strong>: a URL do callback no ML deve ser idêntica à usada no app.</li>
          </ul>
        </section>

        <section id="faq">
          <h2>FAQ</h2>
          <p><strong>Expira o token?</strong> Sim. O app renova automaticamente usando o <em>refresh_token</em>.</p>
          <p><strong>Suporta múltiplas contas?</strong> Sim. Use <code>/api/ml/accounts</code> e <code>/api/ml/active</code>.</p>
        </section>
      </div>
    </main>
  </div>
</body>
</html>
