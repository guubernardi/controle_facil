<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Sistema de gerenciamento de devoluções - Edição e controle de processos de devolução do Mercado Livre">
  <link rel="shortcut icon" href="assets/img/favicon.png" type="image/x-icon">
  <title>Controle Fácil - Devolução</title>
  <link rel="stylesheet" href="css/devolucao.css">
</head>
<body>
  <div class="devolucao-page">
    <!-- Topbar -->
    <div class="topbar-mini">
      <a href="index.html" class="topbar-back" aria-label="Voltar para Devoluções">
        <button type="button" class="voltar" onclick="history.back()">
          <svg class="ico" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
            <path d="M19 12H5M12 19l-7-7 7-7"/>
          </svg>
          <span>Voltar</span>
        </button>
      </a>
    </div>

    <main class="page-wrap" role="main">
      <!-- Header -->
      <header class="page-head">
        <div>
          <h1 class="title">
            Devolução 
            <span id="dv-id" class="kbd" aria-live="polite"></span>
          </h1>
          <p class="hint">
            <strong>Regras:</strong> Rejeitado = R$ 0,00 · Motivo do cliente = R$ 0,00 · Recebido no CD/Inspeção = só frete
            <span id="auto-hint"></span>
          </p>
        </div>

        <div class="actions" role="group" aria-label="Ações da devolução">
          <button id="btn-enrich" class="btn btn--ghost btn--lg" type="button" title="Atualizar dados a partir do ML">
            <svg class="btn__icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
              <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/>
            </svg>
            <span>Atualizar dados (ML)</span>
          </button>

          <span class="actions-split" aria-hidden="true"></span>

          <!-- Marcação operacional -->
          <div class="mark-wrap">
            <label for="mark-op" class="sr-only">Marcar devolução como</label>
            <select id="mark-op" class="select-lg" title="Marcar devolução como">
              <option value="concluida">Concluída</option>
              <option value="em_espera" selected>Em espera</option>
              <option value="defeituosa">Defeituosa</option>
              <option value="troca">Troca</option>
              <option value="reembolso_parcial">Reembolso parcial</option>
            </select>
            
            <input id="mark-obs" type="text" class="input-lg" placeholder="Observação (opcional)" />
            
            <button id="btn-mark" class="btn btn--success btn--lg" type="button" title="Aplicar marcação">
              <svg class="btn__icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                <polyline points="20 6 9 17 4 12"/>
              </svg>
              <span>Aplicar</span>
            </button>
          </div>
        </div>
      </header>

      <!-- Dialogs -->
      <!-- Modal Recebimento no CD (atualizado) -->
      <dialog id="dlg-recebido" class="dialog" aria-labelledby="rcd-title">
        <form method="dialog" id="rcd-form" class="dialog-body">
          <h3 id="rcd-title">Recebimento no CD</h3>
          <p class="dialog-desc">Registre quem recebeu, o horário e se o item chegou completo.</p>

          <div class="dialog-grid" style="grid-template-columns:1fr 1fr; gap:12px;">
            <div>
              <label for="rcd-resp">Quem recebeu?</label>
              <input id="rcd-resp" type="text" placeholder="Ex.: João (CD)" autocomplete="off" required />
            </div>

            <div>
              <label for="rcd-when">Horário</label>
              <input id="rcd-when" type="datetime-local" required />
            </div>

            <div style="grid-column:1 / -1;">
              <label for="rcd-ok">Chegou de tudo certo?</label>
              <select id="rcd-ok" required>
                <option value="" disabled selected>Selecione…</option>
                <option value="sim">Sim</option>
                <option value="nao">Não</option>
              </select>
              <small id="rcd-help" style="display:block;opacity:.8;margin-top:6px;"></small>
            </div>
          </div>

          <div class="dialog-actions">
            <div class="dialog-actions-right">
              <button type="button" class="btn btn--ghost" id="rcd-cancel">Cancelar</button>
              <button id="rcd-confirm" type="submit" class="btn btn--primary">Confirmar e salvar</button>
            </div>
          </div>

          <p class="dialog-hint">
            Se deixar o responsável vazio, será usado <b>cd</b>. Se não escolher uma data, usamos a atual.
          </p>
        </form>
      </dialog>

      <!-- Grid de Cards -->
      <div class="grid">

        <!-- Dados da Devolução -->
        <section class="card" aria-labelledby="sec-dados">
          <h2 id="sec-dados">Dados da Devolução</h2>

          <div class="row">
            <label for="id_venda">Número do Pedido</label>
            <input id="id_venda" name="id_venda" type="text" placeholder="Ex.: 12345 / TESTE-001" autocomplete="off" />
          </div>

          <div class="row">
            <label for="cliente_nome">Cliente</label>
            <input id="cliente_nome" name="cliente_nome" type="text" placeholder="Nome do cliente" autocomplete="name" />
          </div>

          <div class="row-group">
            <div class="row">
              <label for="loja_nome">Loja (apelido no canal)</label>
              <input id="loja_nome" name="loja_nome" type="text" placeholder="Ex.: Minha Loja Oficial" autocomplete="organization" />
            </div>
            <div class="row">
              <label for="data_compra">Data da compra</label>
              <input id="data_compra" name="data_compra" type="date" inputmode="numeric" />
            </div>
          </div>

          <div class="row-group">
            <div class="row">
              <label for="status">Status (interno)</label>
              <select id="status" name="status">
                <option value="">—</option>
                <option value="pendente">Pendente</option>
                <option value="em_analise">Em análise</option>
                <option value="aprovado">Aprovado</option>
                <option value="rejeitado">Rejeitado</option>
                <option value="cancelado">Cancelado</option>
              </select>
            </div>

            <div class="row">
              <label for="tipo_reclamacao">Motivo da reclamação</label>
              <select id="tipo_reclamacao" name="tipo_reclamacao">
                <option value="">—</option>
                <option value="produto_defeituoso">Produto defeituoso</option>
                <option value="produto_danificado">Produto danificado</option>
                <option value="nao_corresponde">Não corresponde à descrição</option>
                <option value="arrependimento_cliente">Arrependimento do cliente</option>
                <option value="entrega_atrasada">Entrega atrasada</option>
              </select>
            </div>
          </div>

          <div class="row">
            <label for="sku">SKU / Item ID</label>
            <input id="sku" name="sku" type="text" placeholder="Ex.: SKU-12345" autocomplete="off" class="font-mono" />
          </div>

          <input id="order_id" name="order_id" type="hidden" />
          <input id="ml_claim_id" name="ml_claim_id" type="hidden" />
        </section>

        <!-- Valores -->
        <section class="card" aria-labelledby="sec-valores">
          <h2 id="sec-valores">Valores</h2>

          <div class="row">
            <label for="valor_produto">Valor do Produto</label>
            <input id="valor_produto" name="valor_produto" type="text" placeholder="0,00" inputmode="decimal" autocomplete="off" />
          </div>

          <div class="row">
            <label for="valor_frete">Valor do Frete</label>
            <input id="valor_frete" name="valor_frete" type="text" placeholder="0,00" inputmode="decimal" autocomplete="off" />
          </div>

          <div class="row">
            <label for="valor_total">Valor Total a Reembolsar</label>
            <input id="valor_total" name="valor_total" type="text" placeholder="0,00" inputmode="decimal" class="input-readonly" readonly />
          </div>

          <!-- Status Box -->
          <div class="status-box">
            <div class="status-item">
              <span class="status-label">Status da Logística</span>
              <span id="pill-log" class="pill -neutro">Pendente</span>
            </div>

            <div class="status-item">
              <span class="status-label">Recebimento no CD</span>
              <button type="button" class="btn btn--sm btn--outline" id="btn-cd">Gerenciar</button>
            </div>

            <div class="cd-details" id="cd-info">
              <span id="pill-cd" class="pill -neutro">Não recebido</span>
              <span id="cd-sep" class="cd-sep" hidden>·</span>
              <span id="cd-resp" class="cd-text" hidden></span>
              <span id="cd-when" class="cd-text" hidden></span>
            </div>
          </div>
        </section>

        <!-- Nota Fiscal -->
        <section class="card" aria-labelledby="sec-nfe">
          <h2 id="sec-nfe">Nota Fiscal</h2>
          <div class="row">
            <label for="nfe_numero">Número da NF-e</label>
            <input id="nfe_numero" name="nfe_numero" type="text" placeholder="Ex.: 12345" autocomplete="off" />
          </div>
          <div class="row">
            <label for="nfe_chave">Chave de acesso (44 dígitos)</label>
            <input id="nfe_chave" name="nfe_chave" type="text" placeholder="35240112345678901234567890123456789012345678" maxlength="44" class="font-mono" autocomplete="off" />
          </div>
        </section>

        <!-- Observações -->
        <section class="card card-span" aria-labelledby="sec-obs">
          <h2 id="sec-obs">Observações</h2>
          <textarea id="reclamacao" name="reclamacao" rows="4" placeholder="Adicione observações sobre esta devolução..."></textarea>
        </section>

        <!-- Histórico (Timeline) -->
        <section class="card" aria-labelledby="sec-hist">
          <h2 id="sec-hist">Histórico</h2>
          <div id="events-loading">Carregando…</div>
          <div id="events-empty" hidden>Nenhum evento ainda</div>
          <div id="events-list" class="timeline"></div>
        </section>
      </div>

      <!-- Footer com ações -->
      <footer class="page-footer">
        <div class="footer-actions">
          <button type="button" class="btn btn--ghost btn--lg" onclick="history.back()">
            <span>Cancelar</span>
          </button>
          <button id="btn-salvar" class="btn btn--primary btn--lg" type="button" title="Salvar alterações (Ctrl/Cmd+S)">
            <svg class="btn__icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
              <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
              <polyline points="17 21 17 13 7 13 7 21"/>
              <polyline points="7 3 7 8 15 8"/>
            </svg>
            <span>Salvar</span>
          </button>
        </div>
      </footer>

    </main>

    <!-- Toast -->
    <div id="toast" class="toast" aria-live="polite"></div>
  </div>

  <script src="js/devolucao-editar.js"></script>
</body>
</html>
