<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Configura√ß√µes - Controle F√°cil</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="../css/navigation.css" />
  <link rel="stylesheet" href="../css/config.css" />
  <link rel="shortcut icon" href="../assets/img/favicon.png" type="image/png">
  
  <style>
    /* Pequeno ajuste para o Toast funcionar nativamente nesta p√°gina */
    .toast {
      position: fixed; bottom: 2rem; right: 2rem;
      background: #1e293b; color: #fff;
      padding: 0.75rem 1.25rem; border-radius: 0.5rem;
      box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
      transform: translateY(100px); opacity: 0;
      transition: all 0.3s; z-index: 9999;
      display: flex; align-items: center; gap: 1rem;
    }
    .toast.show { transform: translateY(0); opacity: 1; }
    .toast.success { background: #22c55e; } /* Verde */
    .toast.error { background: #ef4444; }   /* Vermelho */
  </style>
</head>
<body class="settings-page" data-page="settings">

  <aside id="sidebar" class="sidebar" aria-label="Menu lateral">
    <div class="sidebar-header">
      <a href="../home.html" class="sidebar-logo" aria-label="Controle F√°cil">
        <span class="sidebar-logo-text">Controle F√°cil</span>
      </a>
      <button id="sidebar-toggle" class="sidebar-toggle" aria-label="Alternar menu" title="Menu" aria-expanded="false" aria-controls="sidebar">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <path d="M3 6h18M3 12h18M3 18h18"/>
        </svg>
      </button>
    </div>

    <nav class="sidebar-nav">
      <a class="sidebar-nav-item" data-page="home" href="../home.html">
        <svg class="sidebar-nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M3 10.5 12 3l9 7.5"/><path d="M5 10v10h14V10"/></svg>
        <span class="sidebar-nav-text">Home</span>
      </a>
      <a class="sidebar-nav-item" data-page="central" href="../central.html">
        <svg class="sidebar-nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/></svg>
        <span class="sidebar-nav-text">Central</span>
      </a>
      <a class="sidebar-nav-item" data-page="devolucoes" href="../index.html">
        <svg class="sidebar-nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"><polyline points="9 14 4 9 9 4"/><path d="M20 20v-7a4 4 0 0 0-4-4H4"/></svg>
        <span class="sidebar-nav-text">Devolu√ß√µes</span>
      </a>
      <a class="sidebar-nav-item" data-page="dashboard" href="../dashboard.html">
        <svg class="sidebar-nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
        <span class="sidebar-nav-text">Dashboards</span>
      </a>
      <a class="sidebar-nav-item" data-page="logs" href="../logs.html">
        <svg class="sidebar-nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
        <span class="sidebar-nav-text">Log de Custos</span>
      </a>
      <a class="sidebar-nav-item" data-page="chat" href="../chat.html">
        <svg class="sidebar-nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M21 15a4 4 0 0 1-4 4H8l-5 3V7a4 4 0 0 1 4-4h10a4 4 0 0 1 4 4z"/></svg>
        <span class="sidebar-nav-text">Chat</span>
      </a>
      <a class="sidebar-nav-item" data-page="settings" href="./config.html" aria-current="page">
        <svg class="sidebar-nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7Z"/><path d="M19.4 15a1 1 0 0 0 .2 1.1l.1.1a1 1 0 0 1-.2 1.6l-1.6.9a1 1 0 0 1-1.2-.1l-.1-.1a7.9 7.9 0 0 1-1 .6 1 1 0 0 0-.6.9l-.1 1.8a1 1 0 0 1-1 .9h-1.8a1 1 0 0 1-1-.9l-.1-1.8a1 1 0 0 0-.6-.9 7.9 7.9 0 0 1-1-.6 1 1 0 0 1-1.3.2l-1.6-.9a1 1 0 0 1-.3-1.6l.1-.1A1 1 0 0 0 4.6 15l-1.6-.9a1 1 0 0 1-.5-1.3l.7-1.7a1 1 0 0 1 1-.6h.2c.3-.2.6-.4.9-.6a1 1 0 0 0 .4-1l-.2-1.8A1 1 0 0 1 6.5 4H8.3a1 1 0 0 1 1 .9l.1 1.8a1 1 0 0 0 .6.9l1 .6 1-.6a1 1 0 0 0 .6-.9l.1-1.8a1 1 0 0 1 1-.9h1.8a1 1 0 0 1 1 .9l-.2 1.8a1 1 0 0 0 .4 1c.3.2.6.4.9.6h.2a1 1 0 0 1 1 .6l.7 1.7a1 1 0 0 1-.5 1.3Z"/></svg>
        <span class="sidebar-nav-text">Configura√ß√µes</span>
      </a>
    </nav>

    <div class="sidebar-footer">
      <div class="sidebar-user">
        <div class="sidebar-user-info">
          <div class="sidebar-user-name" id="sidebarUserName">‚Äî</div>
          <div class="sidebar-user-email" id="sidebarUserEmail">‚Äî</div>
        </div>
      </div>
      <button class="sidebar-logout" id="btnLogout" title="Sair" aria-label="Sair">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><path d="M16 17l5-5-5-5"/><path d="M21 12H9"/></svg>
      </button>
    </div>
  </aside>

  <div id="sidebar-overlay" class="sidebar-overlay" aria-hidden="true"></div>

  <main class="conteudo-principal">
    <header class="cabecalho">
      <div class="container">
        <nav class="breadcrumb" aria-label="Voc√™ est√° em">
          <a href="../home.html" class="breadcrumb-link">Home</a>
          <span class="breadcrumb-separador" aria-hidden="true">‚Ä∫</span>
          <span class="breadcrumb-atual" aria-current="page">Configura√ß√µes</span>
        </nav>
      </div>
    </header>

    <section class="banner">
      <div class="container">
        <h1 class="banner-titulo">Central de Configura√ß√µes</h1>
      </div>
    </section>

    <div class="container">
      <div class="nav-voltar">
        <a href="../home.html" class="link-voltar">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="none" aria-hidden="true"><path d="M12.5 15l-5-5 5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          Prefer√™ncias / Empresa
        </a>
      </div>

      <div class="grade-conteudo">
        <aside class="barra-lateral">
          <nav class="menu">
            <a href="#empresa" class="item-menu ativo" data-target="empresa">
              <span class="icone-menu"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M9 21V9"/></svg></span>
              <span class="rotulo-menu">Empresa</span>
            </a>
            <a href="#usuarios" class="item-menu" data-target="usuarios">
              <span class="icone-menu"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"/></svg></span>
              <span class="rotulo-menu">Usu√°rios</span>
            </a>
            <a href="#regras" class="item-menu" data-target="regras">
              <span class="icone-menu"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7Z"/><path d="M19.4 15a1 1 0 0 0 .2 1.1l.1.1a1 1 0 0 1-.2 1.6l-1.6.9a1 1 0 0 1-1.2-.1l-.1-.1a7.9 7.9 0 0 1-1 .6 1 1 0 0 0-.6.9l-.1 1.8a1 1 0 0 1-1 .9h-1.8a1 1 0 0 1-1-.9l-.1-1.8a1 1 0 0 0-.6-.9 7.9 7.9 0 0 1-1-.6 1 1 0 0 1-1.3.2l-1.6-.9a1 1 0 0 1-.3-1.6l.1-.1A1 1 0 0 0 4.6 15l-1.6-.9a1 1 0 0 1-.5-1.3l.7-1.7a1 1 0 0 1 1-.6h.2c.3-.2.6-.4.9-.6a1 1 0 0 0 .4-1l-.2-1.8A1 1 0 0 1 6.5 4H8.3a1 1 0 0 1 1 .9l.1 1.8a1 1 0 0 0 .6.9l1 .6 1-.6a1 1 0 0 0 .6-.9l.1-1.8a1 1 0 0 1 1-.9h1.8a1 1 0 0 1 1 .9l-.2 1.8a1 1 0 0 0 .4 1c.3.2.6.4.9.6h.2a1 1 0 0 1 1 .6l.7 1.7a1 1 0 0 1-.5 1.3Z"/></svg></span>
              <span class="rotulo-menu">Regras</span>
            </a>
            <a href="#integracoes" class="item-menu" data-target="integracoes">
              <span class="icone-menu"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9V2m0 0L3 5m3-3 3 3M6 20a8 8 0 1 0 8-8"/><circle cx="15" cy="15" r="5"/><path d="M12 15h7"/></svg></span>
              <span class="rotulo-menu">Integra√ß√µes</span>
            </a>
          </nav>
        </aside>

        <section class="area-conteudo">
          
          <section id="empresa" class="config-pane active" aria-labelledby="tab-empresa">
            <h2 class="titulo-secao-main">Configura√ß√µes da empresa</h2>
            <form id="form-empresa" class="form-grid" autocomplete="off">
              <div class="form-row">
                <label>Raz√£o social</label>
                <input name="razao_social" type="text" placeholder="Minha Empresa Ltda">
              </div>
              <div class="form-row">
                <label>Nome fantasia</label>
                <input name="nome_fantasia" type="text" placeholder="Controle F√°cil">
              </div>
              <div class="form-row">
                <label>CNPJ</label>
                <input name="cnpj" type="text" inputmode="numeric" placeholder="00.000.000/0000-00">
              </div>
              <div class="form-row">
                <label>E-mail</label>
                <input name="email" type="email" placeholder="contato@empresa.com.br">
              </div>
              <div class="form-row">
                <label>Telefone</label>
                <input name="telefone" type="text" placeholder="(11) 99999-0000">
              </div>
              <div class="form-row" style="grid-column:1/-1">
                <label>Endere√ßo</label>
                <input name="endereco" type="text" placeholder="Rua, n√∫mero, bairro, cidade/UF, CEP">
              </div>
              <div class="actions-line">
                <button class="btn btn--primary" type="submit">Salvar altera√ß√µes</button>
                <button class="btn btn--ghost" type="button" id="empresa-recarregar">Recarregar</button>
              </div>
            </form>
          </section>

          <section id="usuarios" class="config-pane" aria-labelledby="tab-usuarios">
            <h2 class="titulo-secao-main">Usu√°rios & Permiss√µes</h2>
            <div class="card-bloco">
              <form id="form-add-user" class="inline-form" autocomplete="off">
                <input name="nome"  placeholder="Nome" required aria-label="Nome">
                <input name="email" type="email" placeholder="email@exemplo.com" required aria-label="E-mail">
                <select name="papel" aria-label="Papel do usu√°rio">
                  <option value="admin">Admin</option>
                  <option value="gestor">Gestor</option>
                  <option value="operador">Operador</option>
                </select>
                <button class="btn btn--primary" id="add" type="submit">Adicionar</button>
              </form>
              <table class="tabela" aria-label="Lista de usu√°rios">
                <thead><tr><th>Nome</th><th>E-mail</th><th>Papel</th><th>A√ß√µes</th></tr></thead>
                <tbody id="usuarios-list"></tbody>
              </table>
              <div class="actions-line">
                <button class="btn btn--primary" id="usuarios-salvar">Salvar altera√ß√µes</button>
              </div>
            </div>
          </section>

          <section id="regras" class="config-pane" aria-labelledby="tab-regras">
            <h2 class="titulo-secao-main">Regras de Custos</h2>
            <form id="form-regras" class="form-grid">
              <h3 class="sub" style="grid-column:1/-1; font-size: 16px; font-weight: 600; margin-bottom: 12px;">C√°lculo do custo</h3>
              <label class="switch" style="grid-column:1/-1">
                <input type="checkbox" name="rule_rejeitado_zero" checked>
                <span>Quando <b>Status = Rejeitada</b> ‚ûú custo = <b>R$ 0,00</b></span>
              </label>
              <label class="switch" style="grid-column:1/-1">
                <input type="checkbox" name="rule_motivo_cliente_zero" checked>
                <span>Quando <b>Motivo do cliente</b> ‚ûú custo = <b>R$ 0,00</b></span>
              </label>
              <label class="switch" style="grid-column:1/-1">
                <input type="checkbox" name="rule_cd_somente_frete" checked>
                <span>Quando <b>Recebido no CD / Em inspe√ß√£o</b> ‚ûú custo = <b>somente frete</b></span>
              </label>
              <p class="help" style="grid-column:1/-1">Regra padr√£o: <b>Produto + Frete</b>.</p>
              <div class="actions-line" style="grid-column:1/-1">
                <button class="btn btn--primary" type="submit">Salvar altera√ß√µes</button>
              </div>
            </form>
          </section>

          <section id="integracoes" class="config-pane" aria-labelledby="tab-integracoes">
            <h2 class="titulo-secao-main">Integra√ß√µes</h2>
            <div class="integrations-section">
              <h3 class="integrations-title">E-commerces</h3>
              <div class="integrations-grid">
                
                <article class="integration-card" id="ml-card">
                  <header class="integration-head">
                    <div class="integration-logo">
                      <img src="../assets/img/logo_mercadolivre.png" alt="Logo Mercado Livre" onerror="this.src='https://http2.mlstatic.com/frontend-assets/ui-navigation/5.18.9/mercadolibre/logo__large_plus.png'"/>
                    </div>
                    <div>
                      <h3>Mercado Livre</h3>
                      <small class="integration-status">
                        <span class="ml-pill" id="ml-status">Verificando...</span>
                      </small>
                    </div>
                    <span class="badge badge--ecom">Ativo</span>
                  </header>

                  <div class="integration-actions">
                    <a class="btn btn--primary btn--sm" href="/api/auth/ml/login" id="btn-connect-ml">Conectar</a>
                    <button class="btn btn--ghost btn--sm" type="button" id="btn-sync-ml" hidden>Sincronizar Agora</button>
                  </div>
                  
                  <div class="integration-extra">
                    <small style="color:#64748b;">Sincroniza devolu√ß√µes e reclama√ß√µes a cada 10min.</small>
                  </div>
                </article>

                <article class="integration-card is-disabled" aria-disabled="true">
                  <header class="integration-head">
                    <div class="integration-logo"><img src="../assets/img/logo_shopee.png" alt="Logo Shopee"></div>
                    <div><h3>Shopee</h3><small>Em breve</small></div>
                  </header>
                  <div class="integration-actions">
                    <button class="btn" disabled>Aguarde</button>
                  </div>
                </article>
              </div>
            </div>
          </section>

        </section>
      </div>
    </div>
  </main>

  <div id="toast" class="toast" role="status" aria-live="polite">
    <div class="toast-content">
      <strong id="toast-titulo"></strong>
      <div id="toast-descricao"></div>
    </div>
  </div>

  <button id="sidebar-toggle-mobile" class="sidebar-fab" aria-label="Abrir menu">
    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M3 12h18M3 18h18"/></svg>
  </button>

  <script src="/js/auth-guard.js"></script>
  <script src="../js/navigation.js" defer></script>
  <script src="../js/config.js" defer></script>
  
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const statusEl = document.getElementById('ml-status');
      const btnConnect = document.getElementById('btn-connect-ml');
      const btnSync = document.getElementById('btn-sync-ml');
      const toast = document.getElementById('toast');

      function showToast(titulo, msg, tipo) {
        toast.querySelector('strong').textContent = titulo;
        toast.querySelector('div').textContent = msg;
        toast.className = `toast show ${tipo}`;
        setTimeout(() => toast.classList.remove('show'), 4000);
      }

      // 1. Verifica se retornou do login com sucesso
      const params = new URLSearchParams(window.location.search);
      if (params.get('status') === 'connected') {
        showToast('Conectado!', 'Integra√ß√£o com Mercado Livre realizada com sucesso.', 'success');
        // Limpa a URL
        window.history.replaceState({}, document.title, window.location.pathname);
      }
      if (params.get('error')) {
        showToast('Erro', 'Falha na conex√£o: ' + params.get('error'), 'error');
      }

      // 2. Verifica status atual da conex√£o
      fetch('/api/auth/ml/status')
        .then(r => r.json())
        .then(data => {
          if (data.connected) {
            statusEl.textContent = `üü¢ Conectado como ${data.nickname}`;
            statusEl.style.color = 'var(--secondary)';
            btnConnect.textContent = 'Trocar Conta';
            btnConnect.className = 'btn btn--ghost btn--sm';
            btnSync.hidden = false;
          } else {
            statusEl.textContent = 'üî¥ Desconectado';
            statusEl.style.color = 'var(--destructive)';
          }
        })
        .catch(() => statusEl.textContent = 'Erro ao verificar status');

      // 3. Bot√£o de Sincroniza√ß√£o Manual
      btnSync.addEventListener('click', () => {
        btnSync.textContent = 'Sincronizando...';
        btnSync.disabled = true;
        fetch('/api/ml/returns/sync?days=30')
          .then(r => r.json())
          .then(res => {
            if(res.ok) showToast('Sucesso', `Sincroniza√ß√£o iniciada. ${res.total || 0} itens encontrados.`, 'success');
            else throw new Error(res.error || 'Erro desconhecido');
          })
          .catch(err => showToast('Erro', 'Falha ao sincronizar: ' + err.message, 'error'))
          .finally(() => {
            btnSync.textContent = 'Sincronizar Agora';
            btnSync.disabled = false;
          });
      });
    });
  </script>
</body>
</html>